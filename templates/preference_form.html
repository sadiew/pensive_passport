{% extends 'base.html' %}

{% block body %}
<div class="row photo-carousel">
    <div id="myCarousel1" class="carousel slide col-md-6" data-ride="carousel">

      <ol class="carousel-indicators">
        <li data-target="#myCarousel1" data-slide-to="0" class="active"></li>
        {% for i in range(1, max_photos) %}
            <li data-target="#myCarousel1" data-slide-to="{{i}}"></li>
        {% endfor %}
      </ol>
      <div class="carousel-inner" role="listbox">
        <div class="item active">
          <img class="flickr-image" src="{{city1.photos[0]}}">
        </div>
        {% for photo in city1.photos[1:max_photos] %}
        <div class="item">
          <img class="flickr-image" src="{{photo}}">
        </div>
        {% endfor %}
      </div>

      <a class="left carousel-control" href="#myCarousel1" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="right carousel-control" href="#myCarousel1" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
    <div id="myCarousel2" class="carousel slide col-md-6" data-ride="carousel">

      <ol class="carousel-indicators">
        <li data-target="#myCarousel2" data-slide-to="0" class="active"></li>
        {% for i in range(1, max_photos) %}
            <li data-target="#myCarousel2" data-slide-to="{{i}}"></li>
        {% endfor %}
      </ol>
      <div class="carousel-inner" role="listbox">
        <div class="item active">
          <img class="flickr-image" src="{{city2.photos[0]}}">
        </div>
        {% for photo in city2.photos[1:max_photos] %}
        <div class="item">
          <img class="flickr-image" src="{{photo}}">
        </div>
        {% endfor %}
      </div>

      <a class="left carousel-control" href="#myCarousel2" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>
      <a class="right carousel-control" href="#myCarousel2" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>
    </div>
</div>

<form id="preference-form">
    <div class="row" id="city-specific-pref">
        <div class="col-md-5 rcorners">
            <div class="form-group">
                <label>Airport
                    <select id="airport-1" name="airport-1" class="form-control airport-dropdown">
                        {% for airport in city1.airports %}
                            <option value="{{airport.airport_code}}">{{airport.name}} - {{airport.airport_code}}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="form-group wow-slider">
                <label>{{city1.name}}</label>
                    <input type="range" min="1" max="10" step="1"  name="wow-factor-1" id="wow-input-1">
            </div>
        </div>
        <div class="col-md-2"></div>
        <div class="col-md-5 rcorners">
            <div class="form-group">
                <label>Airport
                    <select id="airport-2" name="airport-2" class="form-control airport-dropdown">
                        {% for airport in city2.airports %}
                            <option value="{{airport.airport_code}}">{{airport.name}} - {{airport.airport_code}}</option>
                        {% endfor %}
                    </select>
                </label>
            </div>
            <div class="form-group wow-slider">
                <label>{{city2.name}}</label> 
                    <input type="range" min="1" max="10" step="1" name="wow-factor-2" id="wow-input-2">                   
            </div>
        </div>
    </div>

    <div class='container'>
    <table id="results-table" class = "table table-striped">
    <thead>
        <tr>
            <th colspan="3" style="text-align:center; font-size:24px;">The Data</th>
        </tr> 
        <tr>
            <th>Component</th>
            <th class="data-element">{{city1.name}}</th>
            <th class="data-element">{{city2.name}}</th>
        </tr>
    </thead>   
    <tbody>
        <tr>
            <td>Airfare</td>
            <td id="flight-1" class="data-element"></td>
            <td id="flight-2" class="data-element"></td>
        </tr>
        <tr>
            <td>Weather</td>
            <td id="weather-1" class="data-element"></td>
            <td id="weather-2" class="data-element"></td>
        </tr>
        <tr>
            <td>Cost of Living</td>
            <td id="col-1" class="data-element"></td>
            <td id="col-2" class="data-element"></td>
        </tr>
        <tr>
            <td>Food</td>
            <td id="food-1" class="data-element"></td>
            <td id="food-2" class="data-element"></td>
        </tr>    
        <tr>
            <td>Wow Factor</td>
            <td id="wow-1" class="data-element"></td>
            <td id="wow-2" class="data-element"></td>
        </tr>    
    </tbody>
    </table>
    </div>

    <div class="row rcorners" id="general-pref">
        <h2 style="text-align:center">Travel Preferences</h2>
        <div class="col-md-6">
            <div id="departure-airport" class="form-group">
            <label>Home Airport</label>
                <select name="departure-airport" class="form-control airport-dropdown">
                    {% for airport in origin_city.airports %}
                        <option value="{{airport.airport_code}}">{{airport.name}} - {{airport.airport_code}}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="temp-selectors" style="margin-top: 50px;">
                <label>Ideal Temperature</label>
                <label class="radio-inline"><input type="radio" name="ideal-temp" value="50" required><img class="weather-radio" src="/static/images/snowflake.png"></label>
                <label class="radio-inline"><input type="radio" name="ideal-temp" value="70" required><img class="weather-radio" src="/static/images/sun_cloud.png"></label>
                <label class="radio-inline"><input type="radio" name="ideal-temp" value="90" required><img class="weather-radio" src="/static/images/sun.png"></label>
            </div>
                         
        </div>

        <div class="col-md-6">
            <div id="travel-dates" class="form-group"> 
                <label>Departure Date</label>                    
                <input id="depart-date" class="form-control" name="depart-date" min="2015-06-01" max="2015-12-31" type="date" required>
                <label>Return Date</label>
                <input id="return-date" class="form-control" name="return-date" min="2015-06-01" max="2015-12-31" type="date" required>
            </div>
        </div>
        <div class="row" id="component-weights">
            <div class="form-group importance-slider col-md-4">
                <label>Cost</label>                   
                <input type="range" min="0" max="5" step="1" name="cost" id="cost-weight">
            </div>
            <div class="form-group importance-slider col-md-4">
                <label>Quality of Food</label>
                <input type="range" min="0" max="5" step="1" name="food" id="food-weight">
            </div>
            <div class="form-group importance-slider col-md-4">
                <label>Weather</label>
                <input type="range" min="0" max="5" step="1" name="weather" id="weather-weight">
            </div>           
        </div>
         <div id="algo-result">
            <p><span id="recalculation_text"></span><span id="pp-choice-text"></span></p>
            <div><button id="pp-choice" class="btn btn-primary">Explore </button></div>
        </div>
        <div>
            <input type="submit" class="btn btn-primary" id="gather-data-button" value="Grab data!" style="display:block; margin:50px auto;">
        </div>
        </div>
</form>



<script type="text/javascript">
    var cityInfo1 = {};
    var cityInfo2 = {};
    var cities = [cityInfo1, cityInfo2];

    $(document).ready(function(){
        $('#results-table').hide();
        $('#final-decision-form').hide();
        $("#algo-result").hide();
        $("#component-weights").hide();
        });

    function setInitialPhotos() {
        $('#photo-1').attr("style","background-image:url('{{city1.photos[0]}}');");
        $('#photo-2').attr("style","background-image:url('{{city2.photos[0]}}');");
    }



    function prepDom() {
        $("#gather-data-button").hide();
        $("#city-specific-pref").hide();
        $("#travel-dates").hide();
        $("#departure-airport").hide();
        $("#temp-selectors").hide();
        $('#results-table').show();
        $('#final-decision-form').show();
        $('#component-weights').show()
        $(".photo-carousel").hide();

    }

    function determineDestination(cities) {
        var cityInfo1 = cities[0];
        var cityInfo2 = cities[1];

        var idealTemp = $("input:radio[name=ideal-temp]:checked").val();

        var costWeight = parseInt($("#cost-weight").val());
        var foodWeight = parseInt($("#food-weight").val());
        var weatherWeight = parseInt($("#weather-weight").val());
        var totalWeight = costWeight + foodWeight + weatherWeight;

        var flightDelta = (cityInfo1.airfare - cityInfo2.airfare)/(cityInfo1.airfare);
        var colDelta = (cityInfo1.costOfLiving - cityInfo2.costOfLiving)/(cityInfo1.costOfLiving);

        var weatherDeltaCity1 = cityInfo1.weather - idealTemp;
        var weatherDeltaCity2 = cityInfo2.weather - idealTemp;
        var weatherDelta = (weatherDeltaCity1 - weatherDeltaCity2)/weatherDeltaCity1;

        var wowDelta = (cityInfo1.wow - cityInfo2.wow)/cityInfo1.wow;


        if (cityInfo1.food > 0) {
            var starDelta = (cityInfo1.food - cityInfo2.food)/cityInfo1.food;
        }
        else if (cityInfo2.food > 0) {
            var starDelta = -1;
        }

        else {
            var starDelta = 0;
        }

        var dataDelta = (foodWeight/totalWeight)*starDelta -
                        (costWeight*0.5/totalWeight)*colDelta -
                        (costWeight*0.5/totalWeight)*flightDelta - 
                        (weatherWeight/totalWeight)*weatherDelta
        
        if (dataDelta + wowDelta > 0) {
            var winningCity = cityInfo1;
            console.log(winningCity.city);
        }

        else if (dataDelta + wowDelta < 0) {
            var winningCity = cityInfo2;
            console.log(winningCity.city);
        }

        else {var trips = [cityInfo1.city, cityInfo2.city];
            var winningCity = trips[Math.floor(Math.random()*trips.length)];
        }

        if (flightDelta > 0) { $("#flight-2").attr("style", "color:#66CDAA")}
        else if (flightDelta < 0) {$("#flight-1").attr("style", "color:#66CDAA")}

        if (weatherDelta > 0) { $("#weather-2").attr("style", "color:#66CDAA")}
        else if (weatherDelta < 0) {$("#weather-1").attr("style", "color:#66CDAA")}

        if (starDelta > 0) { $("#food-1").attr("style", "color:#66CDAA")}
        else if (starDelta < 0) {$("#food-2").attr("style", "color:#66CDAA")}

        if (colDelta > 0) { $("#col-2").attr("style", "color:#66CDAA")}
        else if (colDelta < 0) {$("#col-1").attr("style", "color:#66CDAA")}

        if (wowDelta > 0) { $("#wow-1").attr("style", "color:#66CDAA")}
        else if (wowDelta < 0) {$("#wow-2").attr("style", "color:#66CDAA")}

        $("#pp-choice").html('Explore ' + winningCity.city);
        $("#pp-choice-text").html("Pensive Passport's algorithm has selected: " + winningCity.city);
        $("#pp-choice").data("city", winningCity.city);
        $("#pp-choice").data("country", winningCity.country);
        $("#pp-choice").data("city_id", winningCity.city_id);
        console.log(dataDelta);
        console.log(wowDelta);
        $("#algo-result").show();

    }          

    function getData(evt){   
        evt.preventDefault();
        prepDom();
        
        var apiResponses = 0;

        for (i=1; i < cities.length + 1; i++) {loopCities(i)}
        
        function loopCities(i) {
            var cityInfo = cities[i-1];
            $("#wow-"+i).html($("#wow-input-"+i).val());
            cityInfo.wow = $("#wow-input-"+i).val()

            var url = '/get-city' + i + '-data?airport-'+i+'='+ $("#airport-"+i).val();
            $.get(url, function (result) {                
                cityInfo.city = result.city;
                cityInfo.city_id = result.city_id;
                cityInfo.country = result.country;
                cityInfo.food = parseInt(result.food.stars);
                cityInfo.food = getNum(cityInfo.food);
                cityInfo.costOfLiving = parseInt(result.costOfLiving);
                $('#food-'+i).html(cityInfo.food + ' ' + "<img class='michelin-star' src='/static/images/michelinstar.jpg'>");
                $('#col-'+i).html(cityInfo.costOfLiving);
                
                }
            );
                        
            $.post("/get-flight" + i,
                {depart_date: $("#depart-date").val(), return_date: $("#return-date").val(), origin: $("#departure-airport").val(), destination: $("#airport-"+i).val()},
                function (result) {
                    $('#flight-'+i).html("$" + result.airfare);
                    cityInfo.airfare = result.airfare;
                    apiResponses ++;
                    if (apiResponses===4) {
                        $.post('/store-trips',
                            {'trip1':JSON.stringify(cities[0]), 'trip2':JSON.stringify(cities[1])}, function(result) {console.log(result)});
                        determineDestination(cities)};
                }
            );

            $.post("/get-weather" + i,
                {depart_date: $("#depart-date").val(), destination: $("#airport-"+i).val()},
                function (result) {
                    $('#weather-'+i).html(result.low + " - " + result.high + " F");
                    cityInfo.weather = (parseInt(result.low) + parseInt(result.high))/2;
                    apiResponses ++;
                    if (apiResponses===4) {
                        $.post('/store-trips',
                            {'trip1':JSON.stringify(cities[0]), 'trip2':JSON.stringify(cities[1])}, function(result) {console.log(result)});
                        determineDestination(cities)};
                }
            );
        }

    }

    function reCalculate() {
        $("#recalculation_text").html("After recalculation, ");
        determineDestination(cities);
        }        

    function exploreCity(evt) {
        var city = $(this).data("city");
        var country = $(this).data("country");
        var city_id = $(this).data("city_id");

        window.location = "http://localhost:5000/results?city=" + city + '&country=' + country + '&city_id=' + city_id;

    }

    function getNum(val)
        {
           if (isNaN(val)) 
             return 0;
           else
             return val;
        }

    $("#preference-form").on("submit", getData);
    $("#pp-choice").on("click", exploreCity);
    $(".importance-slider").on("change", reCalculate);

</script>

{% endblock %}