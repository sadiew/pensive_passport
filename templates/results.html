{% extends 'base.html' %}

{% block body %}
<h1>{{ city }}, {{country}}</h1>

<div class="row" style="margin:20px auto;">   
  <div id="map-canvas" style="width:auto; height:200px"></div>
  
</div>
<div class="row" style="text-align:center">
  <div class="col-md-4 rcorners">
      <div id="restaurant-info">
        <h3>Restaurants</h3>
      </div>
  </div>
  <div class="col-md-4 rcorners">
      <div id="museum-info">
        <h3>Museums</h3>
      </div>
  </div>
  <div class="col-md-4 rcorners">
      <div id="park-info">
        <h3>Parks</h3>
      </div>
  </div>
</div>
<div>
  <div id="similar-trips"></div>
</div>
</div>



<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>

<script>

    $(document).ready(function(){
      getPlaces();
        });

    var geocoder;
    var map;
    var winning_city = '{{city}}' + ', ' + '{{country}}';

    function initialize(location) {
      geocoder = new google.maps.Geocoder();
      geocoder.geocode( { 'address': location}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location
          });
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
      });
      
      var mapOptions = {
        zoom: 12,

      }
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
      console.log(map);
    }

    function getMap() {
      initialize(winning_city);
    }

    function createMarker(place) {
      place.style.color= "black";
      var latLon = (place.getAttribute("data-lat-lon")).split(", ");
      var lat = latLon[0];
      var lon = latLon[1];

      var marker = new google.maps.Marker({
        position: new google.maps.LatLng(lat, lon),
        map: map
        });

    }

    function onPlaceClick(place, evt) {
      evt.preventDefault();
      $(place).next('.description').removeClass('hidden');
      createMarker(place);
      getPlaceDetails(place);
      
      
      /*Add AJAX call to google places for website. Add an <a> tag for link to website.*/
    }

    function getPlaceDetails(place) {
      var request = {
        placeId: $(place).data("google-place-id")
      };

      service = new google.maps.places.PlacesService(map);
      service.getDetails(request, callback)

      function callback(placeObject, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {
        console.log(placeObject.url);
        placeWebsite = placeObject.website;
        placeRating = placeObject.rating;
        console.log(placeRating);
        $(place).next('.description').html("<p>Average Rating: " + placeRating + "</p><a href='" + placeWebsite + "'>Website</a>");
      }
        
      }
    }
    
    function getPlaces() {
        $('#get-places-button').hide();
        
        $.post( "/get-restaurants",
            { city: '{{city}}', country: '{{country}}', city_id: '{{city_id}}'},
            function (result) {
                
                var i=0;
                for (item in result) {
                    var latLon = result[item].lat + ', ' + result[item].lon;
                    var googlePlaceId = result[item].google_place_id;
                
                    $('#restaurant-info').append("<div id='restaurant-" + i + "' class='restaurant'>" +
                                                    "<a href='#' onclick='onPlaceClick(this, event)' data-lat-lon='" + latLon + "' data-google-place-id='" + googlePlaceId + "'>" + item + "</a>" +
                                                    "<div class='description hidden'>Place Test!</div>" +
                                                  "</div>");
                    i++;
                    };
                }
        );

        $.post( "/get-museums",
            { city: '{{city}}', country: '{{country}}', city_id: '{{city_id}}'},
            function (result) { 
            var i=0;
                for (item in result) {
                    var latLon = result[item].lat + ', ' + result[item].lon;    
                    var googlePlaceId = result[item].google_place_id;

                    $('#museum-info').append("<div id='museum-" + i + "' class='museum'>" +
                                                    "<a href='#' onclick='onPlaceClick(this, event)' data-lat-lon='" + latLon + "' data-google-place-id='" + googlePlaceId + "'>" + item + "</a>" +
                                                    "<div class='description hidden'>Place Test!</div>" +
                                                  "</div>");
                    i++;
                };
            }
        );

        $.post( "/get-parks",
            { city: '{{city}}', country: '{{country}}', city_id: '{{city_id}}'},
            function (result) { 
            var i=0;
                for (item in result) {
                    var latLon = result[item].lat + ', ' + result[item].lon;
                    var googlePlaceId = result[item].google_place_id;

                    $('#park-info').append("<div id='park-" + i + "' class='park'>" +
                                                    "<a href='#' onclick='onPlaceClick(this, event)' data-lat-lon='" + latLon + "' data-google-place-id='" + googlePlaceId + "'>" + item + "</a>" +
                                                    "<div class='description hidden'>Place Test!</div>" +
                                                  "</div>");
                    i++;
                };
            }
        );

        $.get( "/get-similar-trips?city_id='{{city_id}}'",
            function (result) {
                $('#similar-trips').append("<h4>Users with similar travel interests also searched:</h4>"); 
                for (item in result) {
                    $('#similar-trips').append("<p><a href='/cities/" + item + "'>" + result[item] + "</a></p>");
                };
            }
        );


    };

    function addPlaceByType(type) {
      $.post( "/get-" + type + 's',
            { city: '{{city}}', country: '{{country}}', city_id: '{{city_id}}'},
            function (result) {
                $('#'+type+'-info').append("<h3>Restaurants</h3>");
                var i=0;
                for (item in result) {
                    var latLon = result[item].lat + ', ' + result[item].lon;
                    var googlePlaceId = result[item].google_place_id;
                
                    $('#restaurant-info').append("<div id='restaurant-" + i + "' class='restaurant'>" +
                                                    "<a href='#' onclick='onPlaceClick(this, event)' data-lat-lon='" + latLon + "' data-google-place-id='" + googlePlaceId + "'>" + item + "</a>" +
                                                    "<div class='description hidden'>Place Test!</div>" +
                                                  "</div>");
                    i++;
                    };
                }
        );

    }

    google.maps.event.addDomListener(window, 'load', getMap);
</script>

{% endblock %}