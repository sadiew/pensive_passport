{% extends 'base.html' %}

{% block body %}
<h1 class="city-header"><strong>{{ city }}, {{country}}</strong></h1>

<div class="row" style="margin:20px auto;">   
  <div id="map-canvas" class="rcorners" style="width:auto; height:200px"></div>
  
</div>
<div class="row" style="text-align:center">
  <div class="col-md-4">
      <div id="restaurant-info">
        <h3 class="place-header"><strong>Restaurants</strong></h3>
      </div>
  </div>
  <div class="col-md-4">
      <div id="museum-info">
        <h3 class="place-header"><strong>Museums</strong></h3>
      </div>
  </div>
  <div class="col-md-4">
      <div id="park-info">
        <h3 class="place-header"><strong>Parks</strong></h3>
      </div>
  </div>
</div>
<div>
  <div id="similar-trips"></div>
</div>
</div>



<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>

<script>

    $(document).ready(function(){
      getPlaces();
        });

    var geocoder;
    var map;
    var winning_city = '{{city}}' + ', ' + '{{country}}';

    function initialize(location) {
      geocoder = new google.maps.Geocoder();
      geocoder.geocode( { 'address': location}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location
          });
        } else {
          alert('Geocode was not successful for the following reason: ' + status);
        }
      });
      
      var mapOptions = {
        zoom: 12,

      }
      map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
    }

    function getMap() {
      initialize(winning_city);
    }

    function onPlaceClick(place, evt) {
      evt.preventDefault();
      $(place).parent().addClass('rcorners');
      $(place).next('.description').removeClass('hidden');
      getPlaceDetails(place);
    }

    function getPlaceDetails(place) {
      var request = {
        placeId: $(place).data("google-place-id")
      };

      var infowindow = new google.maps.InfoWindow();

      service = new google.maps.places.PlacesService(map);
      service.getDetails(request, callback)

      function callback(placeObject, status) {
        if (status == google.maps.places.PlacesServiceStatus.OK) {

          var marker = new google.maps.Marker({
          map: map,
          position: placeObject.geometry.location
          });
          google.maps.event.addListener(marker, 'click', function() {
            infowindow.setContent(placeObject.name);
            infowindow.open(map, this);
          });
        
        var placeWebsite = placeObject.website;
        var placeRating = placeObject.rating || 'Unrated';

        $(place).next('.description').html("<p>Average Rating: " + placeRating + "</p><a href='" + placeWebsite + "'>Website</a>");
      }
        
      }
    }
    
    function getPlaces() {
        $('#get-places-button').hide();        
        addPlaceByType('restaurant');
        addPlaceByType('museum');
        addPlaceByType('park');

        $.get( "/get-similar-trips?city_id='{{city_id}}'",
            function (result) {
                $('#similar-trips').append("<h4 class='secondary-color'>Users with similar travel interests also searched:</h4>"); 
                for (item in result) {
                    $('#similar-trips').append("<p><a href='/cities/" + item + "'>" + result[item] + "</a></p>");
                };
            }
        );
    };

    function addPlaceByType(type) {
      $.post( "/get-" + type + 's',
            { city: '{{city}}', country: '{{country}}', city_id: '{{city_id}}'},
            function (result) {
                var i=0;
                for (item in result) {
                    var latLon = result[item].lat + ', ' + result[item].lon;
                    var googlePlaceId = result[item].google_place_id;
                
                    $('#' + type + '-info').append("<div id='" + type + "'-" + i + "' class='" + type + "'>" +
                                                    "<a href='#' onclick='onPlaceClick(this, event)' data-google-place-id='" + googlePlaceId + "'>" + item + "</a>" +
                                                    "<div class='description hidden'></div>" +
                                                  "</div>");
                    i++;
                    };
                }
        );

    }

    google.maps.event.addDomListener(window, 'load', getMap);
</script>

{% endblock %}